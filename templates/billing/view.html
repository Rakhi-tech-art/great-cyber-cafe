{% extends "base.html" %}

{% block title %}View Invoice - Smart Billing System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-file-invoice me-2"></i>Invoice {{ bill.bill_number }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('billing.bills') }}">Invoices</a></li>
                <li class="breadcrumb-item active">{{ bill.bill_number }}</li>
            </ol>
        </nav>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <a href="{{ url_for('billing.edit', id=bill.id) }}" class="btn btn-primary">
                <i class="fas fa-edit me-1"></i>Edit
            </a>
            <a href="{{ url_for('billing.download_pdf', id=bill.id) }}" class="btn btn-success">
                <i class="fas fa-download me-1"></i>Download PDF
            </a>
            <button class="btn btn-info" onclick="sendBill()">
                <i class="fas fa-paper-plane me-1"></i>Send
            </button>
            {% if bill.status != 'paid' and bill.remaining_amount > 0 %}
            <button class="btn btn-warning" onclick="updatePayment({{ bill.id }}, {{ bill.remaining_amount }})">
                <i class="fas fa-money-bill-wave me-1"></i>Update Payment
            </button>
            {% endif %}
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    Status: {{ bill.status.title() }}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('draft')">Draft</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('sent')">Sent</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('paid')">Paid</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('cancelled')">Cancelled</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Display -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Invoice Header -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h3>Smart Billing System</h3>
                        <p class="text-muted">
                            Your Business Address<br>
                            City, State, ZIP<br>
                            Phone: (123) 456-7890<br>
                            Email: info@smartbilling.com
                        </p>
                    </div>
                    <div class="col-md-6 text-end">
                        <h2 class="text-primary">INVOICE</h2>
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td class="text-end"><strong>Invoice #:</strong></td>
                                <td>{{ bill.bill_number }}</td>
                            </tr>
                            <tr>
                                <td class="text-end"><strong>Date:</strong></td>
                                <td>{{ bill.created_at.strftime('%B %d, %Y') }}</td>
                            </tr>
                            <tr>
                                <td class="text-end"><strong>Time:</strong></td>
                                <td>{{ bill.created_at.strftime('%I:%M %p') }}</td>
                            </tr>
                            {% if bill.due_date %}
                            <tr>
                                <td class="text-end"><strong>Due Date:</strong></td>
                                <td>{{ bill.due_date.strftime('%B %d, %Y') }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td class="text-end"><strong>Status:</strong></td>
                                <td>
                                    <span class="badge bg-{{ 'success' if bill.status == 'paid' else 'warning' if bill.status == 'sent' else 'info' if bill.status == 'draft' else 'secondary' }}">
                                        {{ bill.status.title() }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Bill To:</h5>
                        <p>
                            <strong>{{ bill.customer.name }}</strong><br>
                            {% if bill.customer.address %}{{ bill.customer.address }}<br>{% endif %}
                            {% if bill.customer.email %}Email: {{ bill.customer.email }}<br>{% endif %}
                            {% if bill.customer.phone %}Phone: {{ bill.customer.phone }}<br>{% endif %}
                            {% if bill.customer.whatsapp %}WhatsApp: {{ bill.customer.whatsapp }}{% endif %}
                        </p>
                    </div>
                </div>

                <!-- Invoice Items -->
                <div class="table-responsive mb-4">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Description</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-end">Rate</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in bill.items %}
                            <tr>
                                <td>{{ item.description }}</td>
                                <td class="text-center">{{ item.quantity }}</td>
                                <td class="text-end">₹{{ "%.2f"|format(item.rate) }}</td>
                                <td class="text-end">₹{{ "%.2f"|format(item.total) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Invoice Totals -->
                <div class="row">
                    <div class="col-md-6">
                        {% if bill.notes %}
                        <h6>Notes:</h6>
                        <p class="text-muted">{{ bill.notes }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Payment Summary</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-borderless table-sm mb-0">
                                    {% if bill.tax_rate > 0 or bill.discount > 0 %}
                                    <tr>
                                        <td class="text-end"><strong>Subtotal:</strong></td>
                                        <td class="text-end">Rs {{ "%.2f"|format(bill.subtotal) }}</td>
                                    </tr>
                                    {% if bill.tax_rate > 0 %}
                                    <tr>
                                        <td class="text-end">Tax ({{ bill.tax_rate }}%):</td>
                                        <td class="text-end">Rs {{ "%.2f"|format(bill.tax_amount) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if bill.discount > 0 %}
                                    <tr>
                                        <td class="text-end">Discount:</td>
                                        <td class="text-end">-Rs {{ "%.2f"|format(bill.discount) }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr><td colspan="2"><hr class="my-2"></td></tr>
                                    {% endif %}
                                    <tr class="table-primary">
                                        <td class="text-end"><strong>Total Amount:</strong></td>
                                        <td class="text-end"><strong>Rs {{ "%.2f"|format(bill.total_amount) }}</strong></td>
                                    </tr>
                                    <tr class="{% if bill.advance_amount > 0 %}table-success{% else %}table-warning{% endif %}">
                                        <td class="text-end"><strong>Paid Amount:</strong></td>
                                        <td class="text-end"><strong>Rs {{ "%.2f"|format(bill.advance_amount) }}</strong></td>
                                    </tr>
                                    <tr class="{% if bill.remaining_amount == 0 %}table-success{% else %}table-danger{% endif %}">
                                        <td class="text-end"><strong>Remaining Amount:</strong></td>
                                        <td class="text-end"><strong>Rs {{ "%.2f"|format(bill.remaining_amount) }}</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                {% if bill.status == 'paid' and bill.paid_date %}
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Payment Received:</strong> This invoice was paid on {{ bill.paid_date.strftime('%B %d, %Y') }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Send Bill Modal -->
<div class="modal fade" id="sendBillModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Send this invoice to the customer:</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sendEmail" {% if bill.customer.email %}checked{% else %}disabled{% endif %}>
                    <label class="form-check-label" for="sendEmail">
                        Send via Email {% if not bill.customer.email %}(No email address){% endif %}
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sendWhatsApp" {% if bill.customer.whatsapp %}checked{% else %}disabled{% endif %}>
                    <label class="form-check-label" for="sendWhatsApp">
                        Send via WhatsApp {% if not bill.customer.whatsapp %}(No WhatsApp number){% endif %}
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmSend()">Send Invoice</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Update Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Update Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="paymentAmount" class="form-label">Payment Amount (Rs)</label>
                    <input type="number" class="form-control" id="paymentAmount" min="0" step="0.01" placeholder="Enter payment amount">
                    <div class="form-text">Maximum amount: Rs <span id="maxAmount">0.00</span></div>
                </div>
                <div class="alert alert-info">
                    <strong>Current Status:</strong><br>
                    Remaining Amount: Rs <span id="currentRemaining">0.00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmPayment">Record Payment</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function sendBill() {
    const modal = new bootstrap.Modal(document.getElementById('sendBillModal'));
    modal.show();
}

function confirmSend() {
    const sendEmail = document.getElementById('sendEmail').checked;
    const sendWhatsApp = document.getElementById('sendWhatsApp').checked;
    
    if (!sendEmail && !sendWhatsApp) {
        alert('Please select at least one sending method.');
        return;
    }
    
    fetch(`/billing/bills/{{ bill.id }}/send`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            send_email: sendEmail,
            send_whatsapp: sendWhatsApp
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice sent successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error sending invoice: ' + error.message);
    });
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('sendBillModal'));
    modal.hide();
}

function updateStatus(newStatus) {
    if (confirm(`Change invoice status to ${newStatus}?`)) {
        fetch(`/billing/bills/{{ bill.id }}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating status: ' + error.message);
        });
    }
}

// Payment update functionality
function updatePayment(billId, remainingAmount) {
    document.getElementById('maxAmount').textContent = remainingAmount.toFixed(2);
    document.getElementById('currentRemaining').textContent = remainingAmount.toFixed(2);
    document.getElementById('paymentAmount').value = '';
    document.getElementById('paymentAmount').max = remainingAmount;

    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

document.getElementById('confirmPayment').addEventListener('click', function() {
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
    const maxAmount = parseFloat(document.getElementById('maxAmount').textContent);

    if (!paymentAmount || paymentAmount <= 0) {
        alert('Please enter a valid payment amount');
        return;
    }

    if (paymentAmount > maxAmount) {
        alert('Payment amount cannot exceed remaining amount');
        return;
    }

    // Show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    fetch(`/billing/bills/{{ bill.id }}/payment`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            payment_amount: paymentAmount
        })
    })
    .then(response => response.json())
    .then(data => {
        this.disabled = false;
        this.innerHTML = 'Record Payment';

        if (data.success) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            location.reload(); // Refresh to show updated amounts
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        this.disabled = false;
        this.innerHTML = 'Record Payment';
        alert('Error updating payment: ' + error.message);
    });
});
</script>
{% endblock %}
