{% extends "base.html" %}

{% block title %}Analytics - Smart Billing System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-chart-line me-2"></i>Business Analytics</h1>
        <p class="text-muted">Comprehensive business performance analysis and insights</p>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-calendar me-1"></i>{{ period.replace('months', ' Months').replace('month', ' Month').title() }}
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('dashboard.analytics', period='1month') }}">1 Month</a></li>
                <li><a class="dropdown-item" href="{{ url_for('dashboard.analytics', period='3months') }}">3 Months</a></li>
                <li><a class="dropdown-item" href="{{ url_for('dashboard.analytics', period='6months') }}">6 Months</a></li>
                <li><a class="dropdown-item" href="{{ url_for('dashboard.analytics', period='12months') }}">12 Months</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-rupee-sign fa-2x mb-2"></i>
                <h3>Rs {{ "%.2f"|format(total_revenue) }}</h3>
                <p class="mb-0">Total Revenue</p>
                <small>{{ revenue_data|length }} months of data</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                <h3>Rs {{ "%.2f"|format(total_expenses) }}</h3>
                <p class="mb-0">Total Expenses</p>
                <small>{{ category_data|length }} categories</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-{{ 'success' if total_profit >= 0 else 'danger' }} text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3>Rs {{ "%.2f"|format(total_profit) }}</h3>
                <p class="mb-0">Net {{ 'Profit' if total_profit >= 0 else 'Loss' }}</p>
                <small>{{ "%.1f"|format((total_profit/total_revenue*100) if total_revenue > 0 else 0) }}% margin</small>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-left-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Average Monthly Revenue</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">Rs {{ "%.0f"|format(total_revenue / (revenue_data|length) if revenue_data|length > 0 else 0) }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-success">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Best Month Revenue</div>
                        {% set max_revenue = 0 %}
                        {% for item in revenue_data %}
                            {% if item.total > max_revenue %}
                                {% set max_revenue = item.total %}
                            {% endif %}
                        {% endfor %}
                        <div class="h5 mb-0 font-weight-bold text-gray-800">Rs {{ "%.0f"|format(max_revenue) }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-trophy fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Average Monthly Expenses</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">Rs {{ "%.0f"|format(total_expenses / (expense_data|length) if expense_data|length > 0 else 0) }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-bar fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Profit Growth</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ "%.1f"|format(profit_growth) }}%</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-percentage fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profit & Loss Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Profit & Loss Analysis</h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary" onclick="updateProfitChart('bar')">Bar Chart</button>
                    <button type="button" class="btn btn-outline-primary" onclick="updateProfitChart('line')">Line Chart</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="profitLossChart" width="400" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-pie-chart me-2"></i>Revenue vs Expenses</h5>
            </div>
            <div class="card-body">
                <canvas id="revenueExpenseChart" width="400" height="200"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-muted">Revenue Share</small>
                            <div class="font-weight-bold text-success">{{ "%.1f"|format((total_revenue/(total_revenue+total_expenses)*100) if (total_revenue+total_expenses) > 0 else 0) }}%</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Expense Share</small>
                            <div class="font-weight-bold text-danger">{{ "%.1f"|format((total_expenses/(total_revenue+total_expenses)*100) if (total_revenue+total_expenses) > 0 else 0) }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Expense Categories</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" width="400" height="200"></canvas>
                {% if category_data %}
                <div class="mt-3">
                    {% set top_category = category_data|sort(attribute='total', reverse=true) %}
                    {% if top_category %}
                    <small class="text-muted">Top Category: <strong>{{ top_category[0].category }}</strong> (Rs {{ "%.0f"|format(top_category[0].total) }})</small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Bill Status Analysis -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Bill Status Breakdown</h5>
            </div>
            <div class="card-body">
                {% if status_data %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                                <th>Total Amount</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for status in status_data %}
                            <tr>
                                <td>
                                    <span class="badge bg-{{ 'success' if status.status == 'paid' else 'warning' if status.status == 'sent' else 'info' if status.status == 'draft' else 'secondary' }}">
                                        {{ status.status.title() }}
                                    </span>
                                </td>
                                <td>{{ status.count }}</td>
                                <td>₹{{ "%.2f"|format(status.total or 0) }}</td>
                                {% set total_count = 0 %}
                                {% for s in status_data %}
                                    {% set total_count = total_count + s.count %}
                                {% endfor %}
                                <td>{{ "%.1f"|format((status.count / (total_count or 1)) * 100) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No bill data available for the selected period.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Top Customers</h5>
            </div>
            <div class="card-body">
                {% if top_customers %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Bills</th>
                                <th>Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in top_customers %}
                            <tr>
                                <td>Customer #{{ customer.customer_id }}</td>
                                <td>{{ customer.bill_count }}</td>
                                <td>₹{{ "%.2f"|format(customer.total_amount) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No customer data available for the selected period.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Business Insights -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Business Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Financial Health</h6>
                        <ul class="list-unstyled">
                            {% if total_profit >= 0 %}
                            <li><i class="fas fa-check-circle text-success me-2"></i>Business is profitable</li>
                            {% else %}
                            <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Business showing losses</li>
                            {% endif %}

                            {% if total_revenue > 0 %}
                                {% set profit_margin = (total_profit/total_revenue*100) %}
                                {% if profit_margin > 20 %}
                                <li><i class="fas fa-thumbs-up text-success me-2"></i>Excellent profit margin ({{ "%.1f"|format(profit_margin) }}%)</li>
                                {% elif profit_margin > 10 %}
                                <li><i class="fas fa-check text-info me-2"></i>Good profit margin ({{ "%.1f"|format(profit_margin) }}%)</li>
                                {% elif profit_margin > 0 %}
                                <li><i class="fas fa-minus-circle text-warning me-2"></i>Low profit margin ({{ "%.1f"|format(profit_margin) }}%)</li>
                                {% endif %}
                            {% endif %}

                            {% if profit_growth > 0 %}
                            <li><i class="fas fa-arrow-up text-success me-2"></i>Profit growing by {{ "%.1f"|format(profit_growth) }}%</li>
                            {% elif profit_growth < 0 %}
                            <li><i class="fas fa-arrow-down text-danger me-2"></i>Profit declining by {{ "%.1f"|format(abs(profit_growth)) }}%</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Recommendations</h6>
                        <ul class="list-unstyled">
                            {% if total_expenses > total_revenue * 0.8 %}
                            <li><i class="fas fa-exclamation-circle text-warning me-2"></i>Consider reducing expenses</li>
                            {% endif %}

                            {% if category_data %}
                                {% set sorted_categories = category_data|sort(attribute='total', reverse=true) %}
                                {% if sorted_categories %}
                                    {% set top_expense = sorted_categories[0] %}
                                    <li><i class="fas fa-info-circle text-info me-2"></i>Monitor {{ top_expense.category }} expenses</li>
                                {% endif %}
                            {% endif %}

                            {% if revenue_data|length > 1 %}
                                {% set sorted_revenue = revenue_data|sort(attribute='month', reverse=true) %}
                                {% if sorted_revenue %}
                                    {% set recent_revenue = sorted_revenue[0].total %}
                                    {% set avg_revenue = total_revenue / revenue_data|length %}
                                    {% if recent_revenue < avg_revenue * 0.8 %}
                                    <li><i class="fas fa-chart-line text-warning me-2"></i>Focus on increasing revenue</li>
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            <li><i class="fas fa-target text-success me-2"></i>Set monthly revenue targets</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Quick Stats</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">Break-even Point</small>
                    <div class="h6">Rs {{ "%.0f"|format(total_expenses) }}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Daily Average Revenue</small>
                    <div class="h6">Rs {{ "%.0f"|format(total_revenue / 30 if total_revenue > 0 else 0) }}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Expense Ratio</small>
                    <div class="h6">{{ "%.1f"|format((total_expenses/total_revenue*100) if total_revenue > 0 else 0) }}%</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Revenue Growth Needed</small>
                    <div class="h6">Rs {{ "%.0f"|format((total_expenses * 1.2) - total_revenue if total_revenue < total_expenses * 1.2 else 0) }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Trends -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Monthly Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="trendsChart" width="400" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let profitLossChart;

document.addEventListener('DOMContentLoaded', function() {
    // Profit & Loss Chart
    const profitLossCtx = document.getElementById('profitLossChart').getContext('2d');
    const revenueLabels = [{% for item in revenue_data %}'{{ item.month }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const revenueAmounts = [{% for item in revenue_data %}{{ item.total }}{% if not loop.last %},{% endif %}{% endfor %}];
    const expenseLabels = [{% for item in expense_data %}'{{ item.month }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const expenseAmounts = [{% for item in expense_data %}{{ item.total }}{% if not loop.last %},{% endif %}{% endfor %}];

    // Create combined labels and calculate profit for each month
    const allLabels = [...new Set([...revenueLabels, ...expenseLabels])].sort();
    const profitData = allLabels.map(label => {
        const revenueIndex = revenueLabels.indexOf(label);
        const expenseIndex = expenseLabels.indexOf(label);
        const revenue = revenueIndex >= 0 ? revenueAmounts[revenueIndex] : 0;
        const expense = expenseIndex >= 0 ? expenseAmounts[expenseIndex] : 0;
        return revenue - expense;
    });

    profitLossChart = new Chart(profitLossCtx, {
        type: 'bar',
        data: {
            labels: allLabels,
            datasets: [{
                label: 'Revenue',
                data: allLabels.map(label => {
                    const index = revenueLabels.indexOf(label);
                    return index >= 0 ? revenueAmounts[index] : 0;
                }),
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: '#28a745',
                borderWidth: 1
            }, {
                label: 'Expenses',
                data: allLabels.map(label => {
                    const index = expenseLabels.indexOf(label);
                    return index >= 0 ? expenseAmounts[index] : 0;
                }),
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: '#dc3545',
                borderWidth: 1
            }, {
                label: 'Profit/Loss',
                data: profitData,
                backgroundColor: profitData.map(value => value >= 0 ? 'rgba(23, 162, 184, 0.8)' : 'rgba(255, 193, 7, 0.8)'),
                borderColor: profitData.map(value => value >= 0 ? '#17a2b8' : '#ffc107'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Rs ' + value.toFixed(0);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': Rs ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            }
        }
    });

    // Revenue vs Expenses Chart
    const revenueExpenseCtx = document.getElementById('revenueExpenseChart').getContext('2d');
    new Chart(revenueExpenseCtx, {
        type: 'doughnut',
        data: {
            labels: ['Revenue', 'Expenses'],
            datasets: [{
                data: [{{ total_revenue }}, {{ total_expenses }}],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 2,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': Rs ' + context.parsed.toFixed(2) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryLabels = [{% for cat in category_data %}'{{ cat.category }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const categoryAmounts = [{% for cat in category_data %}{{ cat.total }}{% if not loop.last %},{% endif %}{% endfor %}];

    new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryAmounts,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#E7E9ED', '#71B37C'
                ],
                borderWidth: 2,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': Rs ' + context.parsed.toFixed(2) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Trends Chart
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');

    new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: allLabels,
            datasets: [{
                label: 'Revenue',
                data: allLabels.map(label => {
                    const index = revenueLabels.indexOf(label);
                    return index >= 0 ? revenueAmounts[index] : 0;
                }),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: false
            }, {
                label: 'Expenses',
                data: allLabels.map(label => {
                    const index = expenseLabels.indexOf(label);
                    return index >= 0 ? expenseAmounts[index] : 0;
                }),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: false
            }, {
                label: 'Profit/Loss',
                data: profitData,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                tension: 0.4,
                fill: false,
                borderDash: [5, 5]
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Rs ' + value.toFixed(0);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': Rs ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            }
        }
    });
});

// Function to update profit chart type
function updateProfitChart(chartType) {
    profitLossChart.config.type = chartType;
    profitLossChart.update();

    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    event.target.classList.remove('btn-outline-primary');
    event.target.classList.add('btn-primary');
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.border-left-primary {
    border-left: 4px solid #007bff !important;
}

.border-left-success {
    border-left: 4px solid #28a745 !important;
}

.border-left-info {
    border-left: 4px solid #17a2b8 !important;
}

.border-left-warning {
    border-left: 4px solid #ffc107 !important;
}

.text-xs {
    font-size: 0.75rem;
}

.font-weight-bold {
    font-weight: 700 !important;
}

.text-gray-800 {
    color: #5a5c69 !important;
}

.text-gray-300 {
    color: #dddfeb !important;
}

.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
    border: 1px solid #e3e6f0 !important;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.chart-container {
    position: relative;
    height: 300px;
}

@media (max-width: 768px) {
    .chart-container {
        height: 250px;
    }
}

.analytics-card {
    transition: transform 0.2s ease-in-out;
}

.analytics-card:hover {
    transform: translateY(-2px);
}

.profit-positive {
    color: #28a745 !important;
}

.profit-negative {
    color: #dc3545 !important;
}
</style>
{% endblock %}
